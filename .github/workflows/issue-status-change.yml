name: Issue Status Change

on:
  issues:
    types: [closed, labeled, unlabeled]

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  handle-status-change:
    runs-on: ubuntu-latest
    steps:
      - name: Handle Issue Status Change
        uses: actions/github-script@v7
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const https = require('https');
            
            console.log('ğŸ” Starting status change workflow...');
            console.log('ğŸ“‹ Webhook URL exists:', !!process.env.SLACK_WEBHOOK_URL);
            
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueUrl = context.payload.issue.html_url;
            const action = context.payload.action;
            const isClosed = context.payload.issue.state === 'closed';
            const labels = context.payload.issue.labels.map(l => l.name);
            const assignees = context.payload.issue.assignees;
            const assignee = assignees.length > 0 ? assignees[0].login : null;
            
            console.log(`ğŸ“Œ Issue #${issueNumber}: ${issueTitle}`);
            console.log(`ğŸ“Œ Action: ${action}, Closed: ${isClosed}`);
            
            const userMapping = {
              'leemjmorris': 'U09R6F3CBHN',
              'jaemoon23': 'U09QR380TLH',
              'LeeChaeBin002': 'U09QFND0J20',
              'Kdwio': 'U09LZ9Q6F3J',
              'bunggoo0105': 'U09RL7QCYV7',
              'JangYeJin1207': 'U09QAEF5FEJ'
            };
            
            function sendToSlack(message) {
              return new Promise((resolve, reject) => {
                console.log('ğŸ“¨ Sending to Slack...');
                console.log('ğŸ“¨ Message:', JSON.stringify(message, null, 2));
                
                const data = JSON.stringify(message);
                const url = new URL(process.env.SLACK_WEBHOOK_URL);
                
                console.log('ğŸ“¨ Slack hostname:', url.hostname);
                console.log('ğŸ“¨ Slack path:', url.pathname);
                
                const options = {
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  console.log('ğŸ“¨ Slack response status:', res.statusCode);
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    console.log('ğŸ“¨ Slack response body:', body);
                    if (res.statusCode === 200) {
                      console.log('âœ… Slack message sent successfully');
                      resolve(body);
                    } else {
                      console.error('âŒ Slack API returned non-200 status');
                      reject(new Error(`Slack returned ${res.statusCode}: ${body}`));
                    }
                  });
                });
                
                req.on('error', (error) => {
                  console.error('âŒ Slack request error:', error);
                  reject(error);
                });
                req.write(data);
                req.end();
              });
            }
            
            function updateNotion(issueNumber, status) {
              return new Promise(async (resolve, reject) => {
                try {
                  console.log('ğŸ“ Updating Notion...');
                  const searchData = JSON.stringify({
                    filter: {
                      property: 'Issue Number',
                      number: { equals: issueNumber }
                    }
                  });
                  
                  const searchOptions = {
                    hostname: 'api.notion.com',
                    path: `/v1/databases/${process.env.NOTION_DATABASE_ID}/query`,
                    method: 'POST',
                    headers: {
                      'Authorization': 'Bearer ' + process.env.NOTION_API_TOKEN,
                      'Content-Type': 'application/json',
                      'Notion-Version': '2022-06-28',
                      'Content-Length': searchData.length
                    }
                  };
                  
                  const searchReq = https.request(searchOptions, (res) => {
                    let body = '';
                    res.on('data', (chunk) => body += chunk);
                    res.on('end', () => {
                      try {
                        const response = JSON.parse(body);
                        if (response.results && response.results.length > 0) {
                          const pageId = response.results[0].id;
                          console.log('ğŸ“ Found Notion page:', pageId);
                          
                          const updateData = JSON.stringify({
                            properties: {
                              'Status': { select: { name: status } }
                            }
                          });
                          
                          const updateOptions = {
                            hostname: 'api.notion.com',
                            path: `/v1/pages/${pageId}`,
                            method: 'PATCH',
                            headers: {
                              'Authorization': 'Bearer ' + process.env.NOTION_API_TOKEN,
                              'Content-Type': 'application/json',
                              'Notion-Version': '2022-06-28',
                              'Content-Length': updateData.length
                            }
                          };
                          
                          const updateReq = https.request(updateOptions, (res) => {
                            let body = '';
                            res.on('data', (chunk) => body += chunk);
                            res.on('end', () => {
                              if (res.statusCode === 200) {
                                console.log('âœ… Notion updated successfully');
                              } else {
                                console.error('âŒ Notion update error:', res.statusCode, body);
                              }
                              resolve(body);
                            });
                          });
                          
                          updateReq.on('error', reject);
                          updateReq.write(updateData);
                          updateReq.end();
                        } else {
                          console.log('âš ï¸ Notion page not found');
                          resolve('Page not found');
                        }
                      } catch (error) {
                        console.error('âŒ Notion search parse error:', error);
                        reject(error);
                      }
                    });
                  });
                  
                  searchReq.on('error', (error) => {
                    console.error('âŒ Notion search request error:', error);
                    reject(error);
                  });
                  searchReq.write(searchData);
                  searchReq.end();
                } catch (error) {
                  console.error('âŒ Notion update error:', error);
                  reject(error);
                }
              });
            }
            
            try {
              if (isClosed) {
                console.log('ğŸ¯ Handling issue closure');
                let prInfo = null;
                
                try {
                  console.log('ğŸ” Searching for related PR...');
                  const prs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'all',
                    per_page: 100
                  });
                  
                  const relatedPR = prs.data.find(pr => 
                    pr.body && pr.body.includes(`#${issueNumber}`) ||
                    pr.title.includes(`#${issueNumber}`)
                  );
                  
                  if (relatedPR) {
                    console.log('âœ… Found related PR:', relatedPR.number);
                    prInfo = {
                      number: relatedPR.number,
                      url: relatedPR.html_url,
                      merged: relatedPR.merged_at !== null
                    };
                  } else {
                    console.log('âš ï¸ No related PR found');
                  }
                } catch (error) {
                  console.error('âŒ PR ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error.message);
                }
                
                await updateNotion(issueNumber, 'Done');
                
                const slackUserId = assignee ? userMapping[assignee] : null;
                const mentionText = slackUserId ? `<@${slackUserId}>` : (assignee || 'ë¯¸ì§€ì •');
                
                const prText = prInfo 
                  ? `\n*ì—°ê²°ëœ PR:* <${prInfo.url}|#${prInfo.number}> ${prInfo.merged ? ':white_check_mark: Merged' : ''}`
                  : '';
                
                const slackMessage = {
                  text: 'Issueê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `:white_check_mark: *Issue ì™„ë£Œ* #${issueNumber}\n*ì œëª©:* ${issueTitle}\n*ë‹´ë‹¹ì:* ${mentionText}${prText}\n<${issueUrl}|:link: Issue ë³´ê¸°>`
                      }
                    }
                  ]
                };
                
                await sendToSlack(slackMessage);
              }
              
              console.log('âœ… Status change workflow completed');
              
            } catch (error) {
              console.error('âŒ Workflow error:', error);
              console.error('âŒ Error stack:', error.stack);
              core.setFailed(error.message);
            }
