name: Issue Workflow

on:
  issues:
    types: [opened, assigned, reopened]

permissions:
  contents: write
  issues: write

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Handle Issue Event
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const https = require('https');
            const { execSync } = require('child_process');
            
            console.log('=== Workflow Started ===');
            
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || '';
            const issueUrl = context.payload.issue.html_url;
            const action = context.payload.action;
            const labels = context.payload.issue.labels.map(l => l.name);
            const assignees = context.payload.issue.assignees;
            const assignee = assignees.length > 0 ? assignees[0].login : null;
            
            console.log(`Issue #${issueNumber}: ${issueTitle}`);
            
            const userMapping = {
              'leemjmorris': 'U09R6F3CBHN',
              'jaemoon23': 'U09QR380TLH',
              'LeeChaeBin002': 'U09QFND0J20',
              'Kdwio': 'U09LZ9Q6F3J',
              'bunggoo0105': 'U09RL7QCYV7',
              'JangYeJin1207': 'U09QAEF5FEJ'
            };
            
            function sendToSlack(message) {
              return new Promise((resolve, reject) => {
                console.log('[Slack] Sending message...');
                const data = JSON.stringify(message);
                const url = new URL(process.env.SLACK_WEBHOOK_URL);
                
                const options = {
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  console.log('[Slack] Status:', res.statusCode);
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    console.log('[Slack] Body:', body);
                    if (res.statusCode === 200 && body === 'ok') {
                      console.log('[Slack] Success!');
                      resolve(body);
                    } else {
                      reject(new Error(`Slack error: ${res.statusCode} - ${body}`));
                    }
                  });
                });
                
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            try {
              if (action === 'opened') {
                console.log('>>> Testing simple Slack message');
                
                const simpleMessage = {
                  text: `New Issue #${issueNumber}: ${issueTitle}`
                };
                
                console.log('[Test] Sending simple message...');
                await sendToSlack(simpleMessage);
                console.log('[Test] Simple message SUCCESS!');
                
                console.log('[Test] Now trying with blocks...');
                const blockMessage = {
                  text: 'New Issue Created',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*New Issue #${issueNumber}*\n${issueTitle}\n<${issueUrl}|View Issue>`
                      }
                    }
                  ]
                };
                
                await sendToSlack(blockMessage);
                console.log('[Test] Block message SUCCESS!');
              }
              
              if (action === 'assigned' && assignee) {
                const slackUserId = userMapping[assignee];
                const mention = slackUserId ? `<@${slackUserId}>` : assignee;
                
                await sendToSlack({
                  text: `Issue #${issueNumber} assigned to ${assignee}`,
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `Issue #${issueNumber} assigned to ${mention}\n<${issueUrl}|View Issue>`
                    }
                  }]
                });
              }
              
              if (action === 'reopened') {
                await sendToSlack({
                  text: `Issue #${issueNumber} reopened`,
                  blocks: [{
                    type: 'section',
                    text: {
                      type: 'mrkdwn',
                      text: `Issue #${issueNumber} reopened\n<${issueUrl}|View Issue>`
                    }
                  }]
                });
              }
              
              console.log('=== Workflow Completed ===');
              
            } catch (error) {
              console.error('=== Workflow Failed ===');
              console.error('Error:', error.message);
              throw error;
            }
