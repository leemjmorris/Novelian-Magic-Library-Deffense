name: Issue Workflow

on:
  workflow_dispatch:
  issues:
    types: [opened, assigned, reopened]

permissions:
  contents: write
  issues: write

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Handle Issue Event
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const https = require('https');
            const { execSync } = require('child_process');
            
            console.log('ğŸš€ Workflow triggered');
            console.log('Event name:', context.eventName);
            console.log('Action:', context.payload.action);
            
            // LMJ : For manual dispatch, exit early with success
            if (context.eventName === 'workflow_dispatch') {
              console.log('âœ… Manual workflow test successful!');
              return;
            }
            
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || 'ë‚´ìš© ì—†ìŒ';
            const issueUrl = context.payload.issue.html_url;
            const action = context.payload.action;
            const labels = context.payload.issue.labels.map(l => l.name);
            const assignees = context.payload.issue.assignees;
            const assignee = assignees.length > 0 ? assignees[0].login : null;
            const milestone = context.payload.issue.milestone?.title || 'ì—†ìŒ';
            
            console.log('Issue workflow test completed successfully!');