name: Auto Create Branch on Issue Assignment

on:
  issues:
    types: [opened, assigned]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    if: github.event.issue.assignee != null
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Create branch for assigned issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ASSIGNEE="${{ github.event.issue.assignee.login }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          
          # LMJ : Check if this issue should create a branch
          if echo "$LABELS" | grep -qE "feature-request|meeting"; then
            echo "This issue type does not create branches"
            gh issue comment $ISSUE_NUMBER --body "‚ÑπÔ∏è **Ïù¥ IssueÎäî Î∏åÎûúÏπòÎ•º ÏûêÎèô ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏäµÎãàÎã§.**"
            exit 0
          fi
          
          # LMJ : Determine branch type from labels
          if echo "$LABELS" | grep -q "bug\|fix"; then
            BRANCH_TYPE="fix"
          elif echo "$LABELS" | grep -q "enhancement\|feature"; then
            BRANCH_TYPE="feature"
          elif echo "$LABELS" | grep -q "documentation\|docs"; then
            BRANCH_TYPE="docs"
          elif echo "$LABELS" | grep -q "refactor"; then
            BRANCH_TYPE="refactor"
          elif echo "$LABELS" | grep -q "data\|csvs"; then
            BRANCH_TYPE="csvs"
          else
            BRANCH_TYPE="feature"
          fi
          
          # LMJ : Clean title and convert to branch name
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\][[:space:]]*//')
          DESCRIPTION=$(echo "$CLEAN_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | sed 's/-$//' | sed 's/^-//')
          
          # LMJ : Branch naming convention: {type}/{issue-number}-{description}
          BRANCH_NAME="${BRANCH_TYPE}/${ISSUE_NUMBER}-${DESCRIPTION}"
          
          echo "Creating branch: $BRANCH_NAME"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout main
          git pull origin main
          
          # LMJ : Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            gh issue comment $ISSUE_NUMBER --body "‚ö†Ô∏è **BranchÍ∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§:** \`$BRANCH_NAME\`"
          else
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            echo "Branch $BRANCH_NAME created successfully"
            
            # LMJ : Add comment to issue
            gh issue comment $ISSUE_NUMBER --body "$(cat <<EOF
‚úÖ **BranchÍ∞Ä ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!**

\`\`\`
$BRANCH_NAME
\`\`\`

üìã **Îã§Ïùå Îã®Í≥Ñ:**
1. Î°úÏª¨ÏóêÏÑú Î∏åÎûúÏπòÎ•º Ï≤¥ÌÅ¨ÏïÑÏõÉÌïòÏÑ∏Ïöî:
   \`\`\`bash
   git fetch origin
   git checkout $BRANCH_NAME
   \`\`\`

2. ÏûëÏóÖÏùÑ ÏôÑÎ£åÌïòÍ≥† Ïª§Î∞ãÌïòÏÑ∏Ïöî

3. PR ÏÉùÏÑ± Ïãú Ïù¥ IssueÎ•º ÏûêÎèôÏúºÎ°ú Îã´ÏúºÎ†§Î©¥ PR ÏÑ§Î™ÖÏóê Îã§ÏùåÏùÑ Ìè¨Ìï®ÌïòÏÑ∏Ïöî:
   \`Closes #$ISSUE_NUMBER\`

üéØ **Îã¥ÎãπÏûê:** @$ASSIGNEE

üí° **Tip:** Î∏åÎûúÏπòÎ™ÖÏóê Issue Î≤àÌò∏(#$ISSUE_NUMBER)Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏñ¥ Ï∂îÏ†ÅÏù¥ Ïö©Ïù¥Ìï©ÎãàÎã§!
EOF
)"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
