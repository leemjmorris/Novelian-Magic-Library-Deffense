name: Issue to Slack with Gemini

on:
  issues:
    types: [opened, closed, reopened]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    permissions:
      issues: read
    
    steps:
      - name: Send to Slack with Gemini
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          script: |
            const https = require('https');
            
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || 'ë‚´ìš© ì—†ìŒ';
            const issueNumber = context.payload.issue.number;
            const issueUrl = context.payload.issue.html_url;
            const action = context.payload.action;
            const labels = context.payload.issue.labels.map(l => l.name).join(', ') || 'ì—†ìŒ';
            const assignees = context.payload.issue.assignees;
            const milestone = context.payload.issue.milestone?.title || 'ì—†ìŒ';
            
            // LMJ : GitHub username to Slack User ID mapping
            const userMapping = {
              'leemjmorris': 'U09R6F3CBHN',
              'jaemoon23': 'U09QR380TLH',
              'LeeChaeBin002': 'U09QFND0J20',
              'Kdwio': 'U09LZ9Q6F3J',
              'bigwaterplz': 'U09PKGUMVA6',
              'kimjiw8698-crypto': 'U09QDRGNT08'
            };
            
            // LMJ : Convert GitHub assignees to Slack User ID mentions
            const slackMentions = assignees.map(a => {
              const userId = userMapping[a.login];
              return userId ? `<@${userId}>` : `@${a.login}`;
            }).join(' ') || 'ë¯¸ë°°ì •';
            
            async function callGemini(prompt) {
              const apiKey = process.env.GEMINI_API_KEY;
              const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
              
              return new Promise((resolve, reject) => {
                const data = JSON.stringify({
                  contents: [{ parts: [{ text: prompt }] }],
                  generationConfig: { temperature: 0.3, maxOutputTokens: 300 }
                });
                
                const req = https.request(url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                }, (res) => {
                  let body = '';
                  res.on('data', d => body += d);
                  res.on('end', () => {
                    try {
                      const response = JSON.parse(body);
                      resolve(response.candidates[0].content.parts[0].text);
                    } catch (e) {
                      reject(e);
                    }
                  });
                });
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            async function sendToSlack(message) {
              const webhookUrl = process.env.SLACK_WEBHOOK_URL;
              const url = new URL(webhookUrl);
              
              return new Promise((resolve, reject) => {
                const data = JSON.stringify({ text: message });
                const req = https.request({
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                }, (res) => {
                  let body = '';
                  res.on('data', d => body += d);
                  res.on('end', () => resolve(body));
                });
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            try {
              console.log('Starting workflow...');
              
              const actionEmoji = { 'opened': 'ğŸ†•', 'closed': 'âœ…', 'reopened': 'ğŸ”„' };
              const actionText = { 'opened': 'ìƒì„±ë¨', 'closed': 'ì™„ë£Œë¨', 'reopened': 'ì¬ì˜¤í”ˆë¨' };
              
              const prompt = `Summarize this GitHub issue in Korean with 2-3 bullet points.

            Title: ${issueTitle}
            Description: ${issueBody}

            RULES:
            - Output ONLY bullet points (use "- " prefix)
            - Each point: maximum 40 Korean characters
            - Focus on KEY ACTIONS
            - NO markdown, NO headers, NO extra text

            Format:
            - First key point
            - Second key point
            - Third key point (if needed)`;

              console.log('Calling Gemini API...');
              let summary;
              try {
                summary = await callGemini(prompt);
                summary = summary.replace(/\*\*/g, '').replace(/###/g, '').trim();
                
                if (!summary.includes('- ')) {
                  const lines = summary.split('\n').filter(l => l.trim());
                  summary = lines.map(l => '- ' + l.trim().replace(/^[-â€¢]\s*/, '')).join('\n');
                }
                
                console.log('Summary generated:', summary);
              } catch (error) {
                console.error('Gemini API error:', error);
                summary = `- ${issueTitle}`;
              }
              
              const slackMessage = `${actionEmoji[action]} *Issue #${issueNumber} ${actionText[action]}*

            *${issueTitle}*

            ${summary}

            ğŸ‘¤ *ë‹´ë‹¹:* ${slackMentions}
            ğŸ·ï¸ *ë ˆì´ë¸”:* ${labels}
            ğŸ“… *ë§ˆì¼ìŠ¤í†¤:* ${milestone}

            ğŸ”— <${issueUrl}|ìì„¸íˆ ë³´ê¸°>`;
              
              console.log('Sending to Slack...');
              await sendToSlack(slackMessage);
              console.log('Successfully sent to Slack!');
              
            } catch (error) {
              console.error('Error:', error);
              core.setFailed(error.message);
            }
