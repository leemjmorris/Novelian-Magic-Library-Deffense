name: Issue to Slack (Gemini-powered)

on:
  issues:
    types: [opened, closed, reopened]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    permissions:
      issues: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process issue with Gemini and send to Slack
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_USER: ${{ github.event.issue.user.login }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
          ISSUE_ASSIGNEES: ${{ toJson(github.event.issue.assignees) }}
          ISSUE_MILESTONE: ${{ github.event.issue.milestone.title }}
          ACTION: ${{ github.event.action }}
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            
            // Gemini API í˜¸ì¶œ í•¨ìˆ˜
            async function callGeminiAPI(prompt) {
              const apiKey = process.env.GEMINI_API_KEY;
              const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
              
              const data = JSON.stringify({
                contents: [{
                  parts: [{
                    text: prompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 800
                }
              });
              
              return new Promise((resolve, reject) => {
                const req = https.request(url, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                }, (res) => {
                  let body = '';
                  res.on('data', chunk => body += chunk);
                  res.on('end', () => {
                    try {
                      const response = JSON.parse(body);
                      const text = response.candidates[0].content.parts[0].text;
                      resolve(text);
                    } catch (error) {
                      reject(error);
                    }
                  });
                });
                
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            // Slackì— ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
            async function sendToSlack(message) {
              const webhookUrl = process.env.SLACK_WEBHOOK_URL;
              const url = new URL(webhookUrl);
              
              const data = JSON.stringify({ text: message });
              
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                }, (res) => {
                  let body = '';
                  res.on('data', chunk => body += chunk);
                  res.on('end', () => resolve(body));
                });
                
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            // ë©”ì¸ ë¡œì§
            try {
              const issueTitle = process.env.ISSUE_TITLE;
              const issueBody = process.env.ISSUE_BODY || 'ë‚´ìš© ì—†ìŒ';
              const issueNumber = process.env.ISSUE_NUMBER;
              const issueUrl = process.env.ISSUE_URL;
              const issueUser = process.env.ISSUE_USER;
              const action = process.env.ACTION;
              const labels = JSON.parse(process.env.ISSUE_LABELS || '[]');
              const assignees = JSON.parse(process.env.ISSUE_ASSIGNEES || '[]');
              const milestone = process.env.ISSUE_MILESTONE || 'ì—†ìŒ';
              
              // ì•¡ì…˜ì— ë”°ë¥¸ ì´ëª¨ì§€
              const actionEmoji = {
                'opened': 'ğŸ†•',
                'closed': 'âœ…',
                'reopened': 'ğŸ”„'
              };
              
              // ë ˆì´ë¸” ì •ë³´
              const labelNames = labels.map(l => l.name).join(', ') || 'ì—†ìŒ';
              
              // ë‹´ë‹¹ì ì •ë³´
              const assigneeNames = assignees.map(a => `@${a.login}`).join(', ') || 'ë¯¸ë°°ì •';
              
              // Geminiì—ê²Œ ìš”ì•½ ìš”ì²­
              const prompt = `ë‹¤ìŒ GitHub Issueë¥¼ í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê³  ë³´ê¸° ì¢‹ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”. 
              
Issue ì œëª©: ${issueTitle}
Issue ë‚´ìš©: ${issueBody}
ì•¡ì…˜: ${action}
ë ˆì´ë¸”: ${labelNames}
ë‹´ë‹¹ì: ${assigneeNames}
ë§ˆì¼ìŠ¤í†¤: ${milestone}

ìš”êµ¬ì‚¬í•­:
1. í•µì‹¬ ë‚´ìš©ë§Œ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½
2. ì¤‘ìš”í•œ ì •ë³´(ìš°ì„ ìˆœìœ„, ë‹´ë‹¹ì, ë§ˆì¼ìŠ¤í†¤ ë“±)ëŠ” ê°•ì¡°
3. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
4. Slack ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ì‘ì„± (markdown ì§€ì›)
5. ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ì‘ì„± (ìµœëŒ€ 200ì)

í˜•ì‹ ì˜ˆì‹œ:
ğŸ“ **[ìš”ì•½]**
í•µì‹¬ ë‚´ìš© ìš”ì•½...

ğŸ‘¤ **ë‹´ë‹¹:** @ì‚¬ìš©ì
ğŸ·ï¸ **ë ˆì´ë¸”:** ë ˆì´ë¸”ë“¤
ğŸ“… **ë§ˆì¼ìŠ¤í†¤:** ë§ˆì¼ìŠ¤í†¤ëª…`;

              console.log('Gemini API í˜¸ì¶œ ì¤‘...');
              const geminiSummary = await callGeminiAPI(prompt);
              console.log('Gemini ìš”ì•½ ì™„ë£Œ:', geminiSummary);
              
              // Slack ë©”ì‹œì§€ êµ¬ì„±
              const slackMessage = `${actionEmoji[action]} *Issue #${issueNumber} ${action === 'opened' ? 'ìƒì„±ë¨' : action === 'closed' ? 'ì™„ë£Œë¨' : 'ì¬ì˜¤í”ˆë¨'}*
              
${geminiSummary}

ğŸ”— <${issueUrl}|Issue ë³´ê¸°>
ğŸ‘¨â€ğŸ’» ì‘ì„±ì: @${issueUser}`;
              
              console.log('Slackìœ¼ë¡œ ì „ì†¡ ì¤‘...');
              await sendToSlack(slackMessage);
              console.log('Slack ì „ì†¡ ì™„ë£Œ!');
              
            } catch (error) {
              console.error('Error:', error);
              core.setFailed(error.message);
            }
