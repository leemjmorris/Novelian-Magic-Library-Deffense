name: Auto Label Ready Issues

on:
  issues:
    types: [opened, edited, assigned, labeled, unlabeled]
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check Ready Status and Add Label
        uses: actions/github-script@v7
        with:
          script: |
            const projectNumber = 5;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            let issuesToCheck = [];
            
            if (context.eventName === 'issues') {
              issuesToCheck = [context.payload.issue.number];
              console.log(`Checking single issue #${context.payload.issue.number}`);
            } else {
              console.log('Checking all issues in project');
            }
            
            const query = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            title
                            labels(first: 10) {
                              nodes {
                                name
                              }
                            }
                            assignees(first: 1) {
                              nodes {
                                login
                              }
                            }
                          }
                        }
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            try {
              const result = await github.graphql(query, {
                owner: owner,
                number: projectNumber
              });
              
              const items = result.user.projectV2.items.nodes;
              console.log(`Found ${items.length} items in project`);
              
              for (const item of items) {
                if (!item.content) continue;
                
                const issue = item.content;
                const issueNumber = issue.number;
                
                if (issuesToCheck.length > 0 && !issuesToCheck.includes(issueNumber)) {
                  continue;
                }
                
                const labels = issue.labels.nodes.map(l => l.name);
                const hasReadyLabel = labels.some(l => l.toLowerCase() === 'ready');
                
                const statusField = item.fieldValues.nodes.find(
                  fv => fv.field && fv.field.name === 'Status'
                );
                
                if (statusField && statusField.name === 'Ready' && !hasReadyLabel) {
                  console.log(`ğŸ·ï¸ Adding 'ready' label to Issue #${issueNumber}`);
                  
                  await github.rest.issues.addLabels({
                    owner: owner,
                    repo: repo,
                    issue_number: issueNumber,
                    labels: ['ready']
                  });
                  
                  console.log(`âœ… Label added to Issue #${issueNumber}: ${issue.title}`);
                }
              }
              
              console.log('âœ… Auto-labeling completed');
              
            } catch (error) {
              console.error('âŒ Error:', error.message);
              throw error;
            }
