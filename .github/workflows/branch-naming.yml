# .github/workflows/branch-naming-convention.yml
name: Branch Naming Convention

on:
  create:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          branch_name="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          
          # main ë¸Œëœì¹˜ëŠ” í†µê³¼
          if [[ "$branch_name" == "main" ]]; then
            echo "âœ… Main branch"
            exit 0
          fi
          
          # ë¸Œëœì¹˜ ëª…ëª… ê·œì¹™ ì²´í¬ (Issue ë²ˆí˜¸ í¬í•¨)
          if [[ "$branch_name" =~ ^(feature|bugfix|hotfix|error-fix|refactor|docs|test|chore|release)/[0-9]+-[a-z0-9-]+$ ]]; then
            echo "âœ… Branch name follows convention: $branch_name"
            ISSUE_NUMBER=$(echo $branch_name | grep -oP '(?<=/)[0-9]+(?=-)')
            echo "Type: $(echo $branch_name | cut -d'/' -f1)"
            echo "Issue: #$ISSUE_NUMBER"
            echo "Description: $(echo $branch_name | cut -d'/' -f2 | cut -d'-' -f2-)"
            
            # PRì¸ ê²½ìš° ì›ë³¸ ì €ì¥ì†Œì—ì„œ Issue í™•ì¸
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              REPO="${{ github.repository }}"
              echo "Checking if issue #$ISSUE_NUMBER exists in $REPO..."
              if gh issue view $ISSUE_NUMBER --repo $REPO --json number > /dev/null 2>&1; then
                echo "âœ… Issue #$ISSUE_NUMBER exists in $REPO"
              else
                echo "âŒ Issue #$ISSUE_NUMBER does not exist in $REPO"
                exit 1
              fi
            else
              # create ì´ë²¤íŠ¸ì¸ ê²½ìš° í˜„ì¬ ì €ì¥ì†Œì—ì„œ í™•ì¸
              echo "Checking if issue #$ISSUE_NUMBER exists..."
              if gh issue view $ISSUE_NUMBER --json number > /dev/null 2>&1; then
                echo "âœ… Issue #$ISSUE_NUMBER exists"
              else
                echo "âŒ Issue #$ISSUE_NUMBER does not exist"
                exit 1
              fi
            fi
          else
            echo "âŒ Branch name doesn't follow convention: $branch_name"
            echo ""
            echo "ğŸ“ Expected format: type/issue-number-description-with-hyphens"
            echo ""
            echo "âœ… Valid types:"
            echo "  â€¢ feature (ìƒˆ ê¸°ëŠ¥)"
            echo "  â€¢ bugfix (ë²„ê·¸ ìˆ˜ì •)"
            echo "  â€¢ hotfix (ê¸´ê¸‰ ìˆ˜ì •)"
            echo "  â€¢ error-fix (ì—ëŸ¬ ìˆ˜ì •)"
            echo "  â€¢ refactor (ì½”ë“œ ê°œì„ )"
            echo "  â€¢ docs (ë¬¸ì„œ ì‘ì—…)"
            echo "  â€¢ test (í…ŒìŠ¤íŠ¸ ì¶”ê°€)"
            echo "  â€¢ chore (ê¸°íƒ€ ì‘ì—…)"
            echo "  â€¢ release (ë¦´ë¦¬ì¦ˆ)"
            echo ""
            echo "âœ… Format rules:"
            echo "  â€¢ Must include issue number after type"
            echo "  â€¢ Only lowercase letters (a-z)"
            echo "  â€¢ Numbers (0-9)"
            echo "  â€¢ Hyphens (-) instead of spaces"
            echo ""
            echo "ğŸ“Œ Examples:"
            echo "  â€¢ feature/123-user-authentication"
            echo "  â€¢ bugfix/456-login-error-fix"
            echo "  â€¢ error-fix/789-null-pointer-exception"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}
