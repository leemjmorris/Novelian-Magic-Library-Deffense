name: PR Issue Link Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  check-issue-link:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR has linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            const pr_body = context.payload.pull_request.body || '';
            const repo = context.repo;
            
            console.log(`ğŸ” Checking PR #${pr_number}`);
            
            // LMJ : Extract issue numbers from PR body
            const issueMatches = pr_body.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi);
            
            if (!issueMatches || issueMatches.length === 0) {
              const comment = `âš ï¸ **PRì— ì—°ê²°ëœ Issueê°€ ì—†ìŠµë‹ˆë‹¤.**
              
PRì„ Issueì™€ ì—°ê²°í•˜ë ¤ë©´ PR ì„¤ëª…ì— ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:
- \`Closes #123\`
- \`Fixes #123\`
- \`Resolves #123\`

ì´ë ‡ê²Œ í•˜ë©´ PRì´ ë¨¸ì§€ë  ë•Œ Issueê°€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`;
              
              await github.rest.issues.createComment({
                ...repo,
                issue_number: pr_number,
                body: comment
              });
              
              core.setFailed('PR must be linked to an issue');
              return;
            }
            
            // LMJ : Extract issue numbers
            const linkedIssues = issueMatches.map(match => {
              const numberMatch = match.match(/#(\d+)/);
              return numberMatch ? numberMatch[1] : null;
            }).filter(Boolean);
            
            console.log(`ğŸ“Œ Linked issues: ${linkedIssues.join(', ')}`);
            
            // LMJ : Verify each linked issue exists
            for (const issueNumber of linkedIssues) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  ...repo,
                  issue_number: parseInt(issueNumber)
                });
                
                console.log(`âœ… Issue #${issueNumber} exists (${issue.state})`);
                
                if (issue.state === 'closed') {
                  console.log(`âš ï¸  Warning: Issue #${issueNumber} is already closed`);
                }
              } catch (error) {
                console.error(`âŒ Issue #${issueNumber} does not exist`);
                core.setFailed(`Issue #${issueNumber} not found`);
                return;
              }
            }
            
            console.log('âœ… All linked issues verified');
